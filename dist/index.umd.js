!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e||self).threedsecureService={})}(this,function(e){function t(){return t=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},t.apply(this,arguments)}var n;!function(e){e[e.Trace=0]="Trace",e[e.Debug=1]="Debug",e[e.Information=2]="Information",e[e.Warning=3]="Warning",e[e.Error=4]="Error",e[e.Critical=5]="Critical",e[e.None=6]="None"}(n||(n={}));var r={__proto__:null,get LogLevel(){return n}},o=/*#__PURE__*/function(){function e(){}return e.convert=function(e){var t=JSON.stringify(e);return btoa(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},e}(),i=/*#__PURE__*/function(){function e(){}return e.create=function(){var e=[48,32,24,16,15,8,4,1].find(function(e){return e<=screen.colorDepth});return{javaEnabled:navigator.javaEnabled(),javascriptEnabled:!0,language:navigator.language,userAgent:navigator.userAgent,screenWidth:window.screen.width,screenHeight:window.screen.height,timezoneOffset:(new Date).getTimezoneOffset(),colorDepth:e,acceptHeader:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"}},e}(),s=/*#__PURE__*/function(){function e(e){var t=this;this._task=void 0,this._timeout=void 0,this._task=new Promise(function(n){t._timeout=setTimeout(n,e)})}var t=e.prototype;return t.wait=function(){return this._task},t.cancel=function(){clearTimeout(this._timeout),this._task=Promise.reject({message:"Timer cancelled"})},e.sleep=function(t){return new e(t)},e.cancel=function(e){clearTimeout(e)},e}(),a=/*#__PURE__*/function(){function e(){}return e.createIFrame=function(e){var t,n=document.createElement("iframe");return n.id=e.name,n.name=e.name,e.useDefaultStyle?n.setAttribute("style","border: none;position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%;opacity: "+(e.isVisible?"1":"0")):n.style.opacity=e.isVisible?"1":"0",null==(t=e.parent)||t.appendChild(n),n},e.createForm=function(e){var t=document.createElement("form");return t.id=e.name,t.name=e.name,t.action=e.actionUrl,t.target=e.target,t.method=e.method,e.parent.appendChild(t),t},e.createInput=function(e){var t=document.createElement("input");return t.id=e.name,t.name=e.name,t.type=e.type,e.parent.appendChild(t),t},e}(),c={__proto__:null,Base64Converter:o,Browser:i,Delay:s,HtmlElementFactory:a,Abstractions:{__proto__:null}};function l(e,t,n){if(!e.s){if(n instanceof u){if(!n.s)return void(n.o=l.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(l.bind(null,e,t),l.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var u=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var i=1&o?t:n;if(i){try{l(r,1,i(this.v))}catch(e){l(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?l(r,1,t?t(o):o):n?l(r,1,n(o)):l(r,2,o)}catch(e){l(r,2,e)}},r},e}();function h(e){return e instanceof u&&1&e.s}var d=/*#__PURE__*/function(){function e(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}return e.prototype.execute=function(e){var t=this,r=e.executeFn,o=e.method,i=e.correlationId;return new Promise(function(e,a){try{var c,d=function(e){var r;if(c)return e;a(p),t._logger.log({message:'Unhandled error calling "'+o+'"',error:null==(r=p)?void 0:r.error,content:{attempt:v,maxAttempts:t._options.maxAttempts},method:o,correlationId:i,level:n.Error})},v=1,p=null,m=function(e,t){var n;do{var r=e();if(r&&r.then){if(!h(r)){n=!0;break}r=r.v}var o=t();if(h(o)&&(o=o.v),!o)return r}while(!o.then);var i=new u,s=l.bind(null,i,2);return(n?r.then(a):o.then(c)).then(void 0,s),i;function a(n){for(r=n;h(o=t())&&(o=o.v),o;){if(o.then)return void o.then(c).then(void 0,s);if((r=e())&&r.then){if(!h(r))return void r.then(a).then(void 0,s);r=r.v}}l(i,1,r)}function c(n){if(n){do{if((r=e())&&r.then){if(!h(r))return void r.then(a).then(void 0,s);r=r.v}if(h(n=t())&&(n=n.v),!n)return void l(i,1,r)}while(!n.then);n.then(c).then(void 0,s)}else l(i,1,r)}}(function(){function l(e){return c?e:(v++,Promise.resolve(s.sleep(t._options.attemptDelay).wait()).then(function(){}))}var u=function(n,o){try{var i=Promise.resolve(r({attempt:v,maxAttempts:t._options.maxAttempts})).then(function(t){if(t.isSuccess)return e(t.data),void(c=1);t.isTransientError||(a(t),c=1)})}catch(e){return o(e)}return i&&i.then?i.then(void 0,o):i}(0,function(e){p={message:'Unhandled error calling "'+o+'"',error:e,additionalData:{attempt:v,maxAttempts:t._options.maxAttempts}},t._logger.log({message:'Unhandled error calling "'+o+'"',error:e,content:{attempt:v,maxAttempts:t._options.maxAttempts},method:o,correlationId:i,level:n.Warning})});return u&&u.then?u.then(l):l(u)},function(){return!c&&v<=t._options.maxAttempts});return Promise.resolve(m&&m.then?m.then(d):d(m))}catch(e){return Promise.reject(e)}})},e}(),v=/*#__PURE__*/function(){function e(e,t,n){void 0===n&&(n=new d(e,t)),this._options=void 0,this._retryPolicy=void 0,this._logger=void 0,this._retryPolicy=n,this._logger=t,this._options=e}var r=e.prototype;return r.send=function(e){try{var r=this,o=r;return Promise.resolve(r._retryPolicy.execute({executeFn:function(i){var s=i.attempt,a=i.maxAttempts;try{var c=1e3*(o._options.timeoutInSeconds||30),l=new AbortController,u=setTimeout(function(){return l.abort()},c);return r._logger.log({message:"[Request] HttpClient",content:{request:e,attempt:s,maxAttempts:a},method:"send",correlationId:e.correlationId,level:n.Information}),Promise.resolve(fetch(e.url,{headers:t({},e.headers,{"x-attempt":s.toString(),"x-max-attempts":a.toString(),accept:"application/json","content-type":"application/json"}),keepalive:!0,body:JSON.stringify(e.body),method:e.method,signal:l.signal})).then(function(t){return r._logger.log({message:"[Response] HttpClient",content:{response:t,attempt:s,maxAttempts:a},method:"send",correlationId:e.correlationId,level:n.Information}),clearTimeout(u),Promise.resolve(t.json()).then(function(e){return{isSuccess:t.ok,isTransientError:r.isTransientError(t),data:t.ok?e.data:e}})})}catch(e){return Promise.reject(e)}},method:"["+e.method+"] "+e.url,correlationId:e.correlationId}))}catch(e){return Promise.reject(e)}},r.isTransientError=function(e){return[409,424,500,503,504].includes(e.status)},e}(),p={__proto__:null,FetchHttpClient:v,Abstractions:{__proto__:null}},m=/*#__PURE__*/function(){function e(){}var t=e.prototype;return t.flush=function(){return Promise.resolve()},t.log=function(e){console.log(JSON.stringify(e))},e}();function g(e,t,n){if(!e.s){if(n instanceof f){if(!n.s)return void(n.o=g.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(g.bind(null,e,t),g.bind(null,e,2));e.s=t,e.v=n;const r=e.o;r&&r(e)}}var f=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var i=1&o?t:n;if(i){try{g(r,1,i(this.v))}catch(e){g(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?g(r,1,t?t(o):o):n?g(r,1,n(o)):g(r,2,o)}catch(e){g(r,2,e)}},r},e}();function _(e){return e instanceof f&&1&e.s}var I=/*#__PURE__*/function(){function e(t,n,r){void 0===n&&(n=new m),void 0===r&&(r=new v(t,n,new d({maxAttempts:3,attemptDelay:5e3},n))),this._httpClient=void 0,this._logger=void 0,this._options=void 0,this._logs=[],this._interval=void 0,this._logger=n,this._options=t,this._httpClient=r,this._interval=setInterval(this.sendBatch.bind(this),1e3*(this._options.batchLogIntervalInSeconds||e.DEFAULT_BATCH_TIMEOUT))}var t=e.prototype;return t.log=function(e){this._logger.log(e),this._options.elasticLoggerUrl&&this._logs.push({customMessage:e.message,message:"[FRONTEND] "+e.message,service:{name:"ThreeDSecure.Service.JS",version:"3.0.0"},executionDate:new Date,entrypoint:"Execute",method:e.method,correlationId:e.correlationId,content:e.content,level:e.level})},t.flush=function(){try{var t=function(){n._interval=setInterval(n.sendBatch.bind(n),1e3*(n._options.batchLogIntervalInSeconds||e.DEFAULT_BATCH_TIMEOUT))},n=this;clearInterval(n._interval);var r=function(e,t,n){for(var r;;){var o=e();if(_(o)&&(o=o.v),!o)return i;if(o.then){r=0;break}var i=n();if(i&&i.then){if(!_(i)){r=1;break}i=i.s}if(t){var s=t();if(s&&s.then&&!_(s)){r=2;break}}}var a=new f,c=g.bind(null,a,2);return(0===r?o.then(u):1===r?i.then(l):s.then(h)).then(void 0,c),a;function l(r){i=r;do{if(t&&(s=t())&&s.then&&!_(s))return void s.then(h).then(void 0,c);if(!(o=e())||_(o)&&!o.v)return void g(a,1,i);if(o.then)return void o.then(u).then(void 0,c);_(i=n())&&(i=i.v)}while(!i||!i.then);i.then(l).then(void 0,c)}function u(e){e?(i=n())&&i.then?i.then(l).then(void 0,c):l(i):g(a,1,i)}function h(){(o=e())?o.then?o.then(u).then(void 0,c):u(o):g(a,1,i)}}(function(){return!!n._logs.length},void 0,function(){return Promise.resolve(n.sendBatch()).then(function(){})});return Promise.resolve(r&&r.then?r.then(t):t())}catch(e){return Promise.reject(e)}},t.sendBatch=function(){try{var e=this,t=e._logs.splice(0,10);if(!t.length)return Promise.resolve();var r=t.map(function(e){return e.correlationId})[0],o=function(n,o){try{var i=Promise.resolve(e._httpClient.send({url:e._options.elasticLoggerUrl,method:"POST",body:t,correlationId:r})).then(function(){})}catch(e){return o(e)}return i&&i.then?i.then(void 0,o):i}(0,function(t){e._logger.log({error:t,message:"Error sending message to elastic",method:"sendBatch",correlationId:r,level:n.Error})});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},e}();I.DEFAULT_BATCH_TIMEOUT=5;var y,A={__proto__:null,ConsoleLogger:m,ElasticLogger:I,Abstractions:r};!function(e){e.width250xheight400="01",e.width390xheight400="02",e.width500xheight600="03",e.width600xheight400="04",e.fullscreen="05"}(y||(y={}));var E={__proto__:null,get ChallengeWindowSize(){return y}},S=/*#__PURE__*/function(){function e(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}return e.prototype.execute=function(t){var r=this;return t.authResponse.challengeUrl?new Promise(function(i,s){try{r._logger.log({message:"[Request] Challenge execution",content:{authResponse:t.authResponse},method:"executeChallenge",correlationId:t.correlationId,level:n.Information}),r._options.container.innerHTML="",a.createIFrame({parent:r._options.container,name:e.IFRAME_NAME,isVisible:!0,useDefaultStyle:!!r._options.onIFrameCreatedFn});var c=a.createForm({parent:r._options.container,name:e.FORM_NAME,actionUrl:t.authResponse.challengeUrl,target:e.IFRAME_NAME,method:"post"}),l=a.createInput({parent:c,name:e.CREQ_INPUT_NAME,type:e.CREQ_INPUT_TYPE}),u={threeDSServerTransID:t.authResponse.processId,acsTransID:t.authResponse.challengeId,messageVersion:t.authResponse.challengeVersion,messageType:"CReq",challengeWindowSize:r._options.challengeWindowSize||y.width250xheight400},h=o.convert(u);l.value=h,c.submit(),r._logger.log({message:"[Response] Challenge execution",content:{authResponse:t.authResponse,cReq:u,base64CReq:h},method:"executeChallenge",correlationId:t.correlationId,level:n.Information}),i()}catch(e){return r._logger.log({message:"[Error] Challenge execution",content:{authResponse:t.authResponse,error:e},method:"executeChallenge",correlationId:t.correlationId,level:n.Error}),s({message:e.toString()})}}):Promise.resolve()},e}();S.IFRAME_NAME="challengeIframe",S.FORM_NAME="challengeForm",S.CREQ_INPUT_NAME="creq",S.CREQ_INPUT_TYPE="hidden";var x=/*#__PURE__*/function(){function e(e,t){this._logger=void 0,this._options=void 0,this._logger=t,this._options=e}return e.prototype.execute=function(t){var r=this;return t.preAuthResponse.dsMethodUrl?new Promise(function(i,s){try{var c;r._logger.log({message:"[Request] DirectoryServer execution",content:t,method:"directoryServerExecute",correlationId:t.correlationId,level:n.Information}),r._options.container.innerHTML="";var l=a.createIFrame({parent:r._options.container,isVisible:!1,name:e.IFRAME_NAME,useDefaultStyle:!!r._options.onIFrameCreatedFn});null==(c=r._options.onIFrameCreatedFn)||c.call(r._options,l);var u=a.createForm({parent:r._options.container,name:e.FORM_NAME,actionUrl:t.preAuthResponse.dsMethodUrl,target:e.IFRAME_NAME,method:"POST"}),h=a.createInput({parent:u,name:e.FORM_INPUT_NAME,type:e.FROM_INPUT_TYPE}),d=o.convert({threeDSServerTransID:t.preAuthResponse.processId,threeDSMethodNotificationURL:t.preAuthResponse.notificationUrl});h.value=d,u.submit(),r._logger.log({message:"[Response] DirectoryServer execution",content:{request:t,threeDSMethodDataBase64:d},method:"directoryServerExecute",correlationId:t.correlationId,level:n.Information}),i()}catch(e){return r._logger.log({message:"[Error] DirectoryServer execution",content:{request:t,error:e},method:"directoryServerExecute",correlationId:t.correlationId,level:n.Error}),s({message:e.toString()})}}):Promise.resolve()},e}();x.IFRAME_NAME="threeDSMethodIframe",x.FORM_NAME="threeDSMethodForm",x.FORM_INPUT_NAME="threeDSMethodData",x.FROM_INPUT_TYPE="hidden";var b=/*#__PURE__*/function(){function e(e,t,n,r,o){void 0===t&&(t=new I(e)),void 0===n&&(n=new v(e,t)),void 0===r&&(r=new x(e,t)),void 0===o&&(o=new S(e,t)),this._options=void 0,this._logger=void 0,this._client=void 0,this._directoryServer=void 0,this._challenge=void 0,this._options=e,this._logger=t,this._client=n,this._directoryServer=r,this._challenge=o}var t=e.prototype;return t.execute=function(e){try{var t=this;return Promise.resolve(t._preAuth(e)).then(function(n){return Promise.resolve(t._directoryServer.execute({preAuthResponse:n,correlationId:e.correlationId})).then(function(){return Promise.resolve(t._auth(e)).then(function(n){return Promise.resolve(t._challenge.execute({authResponse:n,correlationId:e.correlationId})).then(function(){return Promise.resolve(t._postAuth(e)).then(function(e){return Promise.resolve(t._logger.flush()).then(function(){return e})})})})})})}catch(e){return Promise.reject(e)}},t._preAuth=function(e){return this._logger.log({message:"Executing PreAuth",content:e,method:"_preAuth",correlationId:e.correlationId,level:n.Information}),this._client.send({url:this._options.threeDSecureUrl+"/api/v2/"+e.id+"/preAuth",method:"POST",body:{browser:i.create()},correlationId:e.correlationId})},t._auth=function(e){return this._logger.log({message:"Executing Auth",content:e,method:"_auth",correlationId:e.correlationId,level:n.Information}),this._client.send({url:this._options.threeDSecureUrl+"/api/v1/"+e.id+"/auth",method:"POST",correlationId:e.correlationId})},t._postAuth=function(e){return this._logger.log({message:"Executing PostAuth",content:e,method:"_postAuth",correlationId:e.correlationId,level:n.Information}),this._client.send({url:this._options.threeDSecureUrl+"/api/v2/"+e.id+"/postAuth",method:"POST",correlationId:e.correlationId})},e}(),P={__proto__:null,IFrameDirectoryServerService:x,IFrameChallengeService:S,ThreeDSecureService:b,Abstractions:E},T={__proto__:null,Abstractions:{__proto__:null},Utils:c};e.HttpClients=p,e.Loggers=A,e.Services=P,e.Shared=T,e.ThreeDSecureService=b});
//# sourceMappingURL=index.umd.js.map
