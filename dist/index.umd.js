!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e||self).threedsecureService={})}(this,function(e){function t(){return t=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},t.apply(this,arguments)}var n=/*#__PURE__*/function(){function e(){}return e.convert=function(e){var t=JSON.stringify(e);return Buffer.from(t,"utf-8").toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},e}(),r=/*#__PURE__*/function(){function e(){}return e.create=function(){var e=[48,32,24,16,15,8,4,1].find(function(e){return e<=screen.colorDepth});return{javaEnabled:navigator.javaEnabled(),javascriptEnabled:!0,language:navigator.language,userAgent:navigator.userAgent,screenWidth:window.screen.width,screenHeight:window.screen.height,timezoneOffset:(new Date).getTimezoneOffset(),colorDepth:e,acceptHeader:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"}},e}(),o=/*#__PURE__*/function(){function e(e){var t=this;this._task=void 0,this._timeout=void 0,this._task=new Promise(function(n){t._timeout=setTimeout(n,e)})}var t=e.prototype;return t.wait=function(){return this._task},t.cancel=function(){clearTimeout(this._timeout),this._task=Promise.reject({message:"Timer cancelled"})},e.sleep=function(t){return new e(t)},e.cancel=function(e){clearTimeout(e)},e}(),i=/*#__PURE__*/function(){function e(){}return e.createIFrame=function(e){var t,n=document.createElement("iframe");return n.id=e.name,n.name=e.name,e.useDefaultStyle?n.setAttribute("style","border: none;position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%;opacity: "+(e.isVisible?"1":"0")):n.style.opacity=e.isVisible?"1":"0",null==(t=e.parent)||t.appendChild(n),n},e.createForm=function(e){var t=document.createElement("form");return t.id=e.name,t.name=e.name,t.action=e.actionUrl,t.target=e.target,t.method=e.method,e.parent.appendChild(t),t},e.createInput=function(e){var t=document.createElement("input");return t.id=e.name,t.name=e.name,t.type=e.type,e.parent.appendChild(t),t},e}(),s={__proto__:null,Base64Converter:n,Browser:r,Delay:o,HtmlElementFactory:i,Abstractions:{__proto__:null}};function a(e,t,n){if(!e.s){if(n instanceof c){if(!n.s)return void(n.o=a.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(a.bind(null,e,t),a.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var c=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var i=1&o?t:n;if(i){try{a(r,1,i(this.v))}catch(e){a(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?a(r,1,t?t(o):o):n?a(r,1,n(o)):a(r,2,o)}catch(e){a(r,2,e)}},r},e}();function u(e){return e instanceof c&&1&e.s}var l,h=/*#__PURE__*/function(){function e(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}return e.prototype.execute=function(e,t){var n=this;return new Promise(function(r,i){try{var s,l=function(e){if(s)return e;i(p)},h=1,p=null,g=function(e,t){var n;do{var r=e();if(r&&r.then){if(!u(r)){n=!0;break}r=r.v}var o=t();if(u(o)&&(o=o.v),!o)return r}while(!o.then);var i=new c,s=a.bind(null,i,2);return(n?r.then(l):o.then(h)).then(void 0,s),i;function l(n){for(r=n;u(o=t())&&(o=o.v),o;){if(o.then)return void o.then(h).then(void 0,s);if((r=e())&&r.then){if(!u(r))return void r.then(l).then(void 0,s);r=r.v}}a(i,1,r)}function h(n){if(n){do{if((r=e())&&r.then){if(!u(r))return void r.then(l).then(void 0,s);r=r.v}if(u(n=t())&&(n=n.v),!n)return void a(i,1,r)}while(!n.then);n.then(h).then(void 0,s)}else a(i,1,r)}}(function(){function a(e){return s?e:(h++,Promise.resolve(o.sleep(n._options.attemptDelay).wait()).then(function(){}))}var c=function(t,o){try{var a=Promise.resolve(e({attempt:h,maxAttempts:n._options.maxAttempts})).then(function(e){if(e.isSuccess)return r(e.data),void(s=1);e.isTransientError||(i(e),s=1)})}catch(e){return o(e)}return a&&a.then?a.then(void 0,o):a}(0,function(e){n._logger.log(p={message:'Unhandled error calling "'+t+'"',error:e,additionalData:{attempt:h,maxAttempts:n._options.maxAttempts}})});return c&&c.then?c.then(a):a(c)},function(){return!s&&h<=n._options.maxAttempts});return Promise.resolve(g&&g.then?g.then(l):l(g))}catch(e){return Promise.reject(e)}})},e}(),p=/*#__PURE__*/function(){function e(e,t,n){void 0===n&&(n=new h(e,t)),this._options=void 0,this._retryPolicy=void 0,this._logger=void 0,this._retryPolicy=n,this._logger=t}var n=e.prototype;return n.send=function(e){try{var n=this;return Promise.resolve(n._retryPolicy.execute(function(r){var o=r.attempt,i=r.maxAttempts;try{var s=new AbortController,a=setTimeout(function(){return s.abort()},1e3*n._options.timeoutInSeconds);return n._logger.log({message:"[Request] HttpClient",content:{request:e,attempt:o,maxAttempts:i}}),Promise.resolve(fetch(e.url,{headers:t({},e.headers,{"x-attempt":o.toString(),"x-max-attempts":i.toString(),accept:"application/json","content-type":"application/json"}),keepalive:!0,body:JSON.stringify(e.body),method:e.method,signal:s.signal})).then(function(e){n._logger.log({message:"[Response] HttpClient",content:{response:e,attempt:o,maxAttempts:i}}),clearTimeout(a);var t=n.isTransientError(e),r=e.ok;return Promise.resolve(e.json()).then(function(e){return{isSuccess:r,isTransientError:t,data:e}})})}catch(e){return Promise.reject(e)}},"["+e.method+"] "+e.url))}catch(e){return Promise.reject(e)}},n.isTransientError=function(e){return[409,424,500,503,504].includes(e.status)},e}(),g={__proto__:null,FetchHttpClient:p,Abstractions:{__proto__:null}},_=/*#__PURE__*/function(){function e(){}return e.prototype.log=function(e){console.log(JSON.stringify(e))},e}(),m={__proto__:null,ConsoleLogger:_,Abstractions:{__proto__:null}};!function(e){e.width250xheight400="01",e.width390xheight400="02",e.width500xheight600="03",e.width600xheight400="04",e.fullscreen="05"}(l||(l={}));var d={__proto__:null,get ChallengeWindowSize(){return l}},f=/*#__PURE__*/function(){function e(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}return e.prototype.execute=function(t){var r=this;return new Promise(function(o,s){try{r._logger.log({message:"[Request] Challenge execution",content:{authResponse:t}}),i.createIFrame({parent:r._options.container,name:e.IFRAME_NAME,isVisible:!0,useDefaultStyle:!!r._options.onIFrameCreatedFn});var a=i.createForm({parent:r._options.container,name:e.FORM_NAME,actionUrl:t.challengeUrl,target:e.IFRAME_NAME,method:"post"}),c=i.createInput({parent:a,name:e.CREQ_INPUT_NAME,type:e.CREQ_INPUT_TYPE}),u={threeDSServerTransID:t.processId,acsTransID:t.challengeId,messageVersion:t.challengeVersion,messageType:"CReq",challengeWindowSize:r._options.challengeWindowSize||l.width250xheight400},h=n.convert(u);c.value=h,a.submit(),r._logger.log({message:"[Response] Challenge execution",content:{authResponse:t,cReq:u,base64CReq:h}}),o()}catch(e){return r._logger.log({message:"[Error] Challenge execution",content:{authResponse:t,error:e}}),s({message:e.toString()})}})},e}();f.IFRAME_NAME="challengeIframe",f.FORM_NAME="challengeForm",f.CREQ_INPUT_NAME="creq",f.CREQ_INPUT_TYPE="hidden";var v=/*#__PURE__*/function(){function e(e,t){this._logger=void 0,this._options=void 0,this._logger=t,this._options=e}return e.prototype.execute=function(t){var r=this;return t.dsMethodUrl?new Promise(function(o,s){try{var a;r._logger.log({message:"[Request] DirectoryServer execution",content:{preAuthResponse:t}});var c=i.createIFrame({parent:r._options.container,isVisible:!1,name:e.IFRAME_NAME,useDefaultStyle:!!r._options.onIFrameCreatedFn});null==(a=r._options.onIFrameCreatedFn)||a.call(r._options,c);var u=i.createForm({parent:r._options.container,name:e.FORM_NAME,actionUrl:t.dsMethodUrl,target:e.IFRAME_NAME,method:"POST"}),l=i.createInput({parent:u,name:e.FORM_INPUT_NAME,type:e.FROM_INPUT_TYPE}),h=n.convert({threeDSServerTransID:t.processId,threeDSMethodNotificationURL:t.notificationUrl});l.value=h,u.submit(),r._logger.log({message:"[Response] DirectoryServer execution",content:{preAuthResponse:t,threeDSMethodDataBase64:h}}),o()}catch(e){return r._logger.log({message:"[Error] DirectoryServer execution",content:{preAuthResponse:t,error:e}}),s({message:e.toString()})}}):Promise.resolve()},e}();v.IFRAME_NAME="threeDSMethodIframe",v.FORM_NAME="threeDSMethodForm",v.FORM_INPUT_NAME="threeDSMethodData",v.FROM_INPUT_TYPE="hidden";var y=/*#__PURE__*/function(){function e(e,t,n,r,o){void 0===t&&(t=new _),void 0===n&&(n=new p(e,t)),void 0===r&&(r=new v(e,t)),void 0===o&&(o=new f(e,t)),this._options=void 0,this._logger=void 0,this._client=void 0,this._directoryServer=void 0,this._challenge=void 0,this._options=e,this._logger=t,this._client=n,this._directoryServer=r,this._challenge=o}var n=e.prototype;return n.execute=function(e){try{var n=this;return n._logger.log({message:"[Request] PreAuth",content:e}),Promise.resolve(n._preAuth(e)).then(function(e){return n._logger.log({message:"[Response] PreAuth",content:e}),Promise.resolve(n._directoryServer.execute(e)).then(function(){return n._logger.log({message:"[Request] Auth",content:e}),Promise.resolve(n._auth(e)).then(function(e){return n._logger.log({message:"[Response] Auth",content:e}),Promise.resolve(n._challenge.execute(e)).then(function(){return n._logger.log({message:"[Request] PostAuth",content:e}),Promise.resolve(n._postAuth(e)).then(function(e){return n._logger.log({message:"[Response] PostAuth",content:e}),t({},e)})})})})})}catch(e){return Promise.reject(e)}},n._preAuth=function(e){return this._client.send({url:this._options.threeDSecureUrl+"/api/v2/"+e.id+"/preAuth",method:"POST",body:{browser:r.create()}})},n._auth=function(e){return this._client.send({url:this._options.threeDSecureUrl+"/api/v1/"+e.id+"/auth",method:"POST"})},n._postAuth=function(e){return this._client.send({url:this._options.threeDSecureUrl+"/api/v2/"+e.id+"/postAuth",method:"POST"})},e}(),A={__proto__:null,IFrameDirectoryServerService:v,IFrameChallengeService:f,ThreeDSecureService:y,Abstractions:d},S={__proto__:null,Abstractions:{__proto__:null},Utils:s};e.HttpClients=g,e.Loggers=m,e.Services=A,e.Shared=S,e.default=y});
//# sourceMappingURL=index.umd.js.map
