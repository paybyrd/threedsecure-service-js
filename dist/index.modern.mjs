function e(){return e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(e[s]=o[s])}return e},e.apply(this,arguments)}class t{static convert(e){const t=JSON.stringify(e);return btoa(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}}class o{static create(){const e=[48,32,24,16,15,8,4,1].find(e=>e<=screen.colorDepth);return{javaEnabled:navigator.javaEnabled(),javascriptEnabled:!0,language:navigator.language,userAgent:navigator.userAgent,screenWidth:window.screen.width,screenHeight:window.screen.height,timezoneOffset:(new Date).getTimezoneOffset(),colorDepth:e,acceptHeader:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"}}}class s{constructor(e){this._task=void 0,this._timeout=void 0,this._task=new Promise(t=>{this._timeout=setTimeout(t,e)})}wait(){return this._task}cancel(){clearTimeout(this._timeout),this._task=Promise.reject({message:"Timer cancelled"})}static sleep(e){return new s(e)}static cancel(e){clearTimeout(e)}}class r{static createIFrame(e){var t;const o=document.createElement("iframe");return o.id=e.name,o.name=e.name,e.useDefaultStyle?o.setAttribute("style","border: none;position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%;opacity: "+(e.isVisible?"1":"0")):o.style.opacity=e.isVisible?"1":"0",null==(t=e.parent)||t.appendChild(o),o}static createForm(e){const t=document.createElement("form");return t.id=e.name,t.name=e.name,t.action=e.actionUrl,t.target=e.target,t.method=e.method,e.parent.appendChild(t),t}static createInput(e){const t=document.createElement("input");return t.id=e.name,t.name=e.name,t.type=e.type,e.parent.appendChild(t),t}}var n={__proto__:null,Base64Converter:t,Browser:o,Delay:s,HtmlElementFactory:r,Abstractions:{__proto__:null}};class i{constructor(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}execute(e,t){var o=this;return new Promise(async function(r,n){let i=1,a=null;do{try{let t=await e({attempt:i,maxAttempts:o._options.maxAttempts});if(t.isSuccess)return void r(t.data);if(!t.isTransientError)return void n(t)}catch(e){a={message:`Unhandled error calling "${t}"`,error:e,additionalData:{attempt:i,maxAttempts:o._options.maxAttempts}},o._logger.log(a)}i++,await s.sleep(o._options.attemptDelay).wait()}while(i<=o._options.maxAttempts);n(a)})}}class a{constructor(e,t,o=new i(e,t)){this._options=void 0,this._retryPolicy=void 0,this._logger=void 0,this._retryPolicy=o,this._logger=t,this._options=e}async send(t){var o=this;const s=this;return await this._retryPolicy.execute(async function({attempt:r,maxAttempts:n}){const i=1e3*(s._options.timeoutInSeconds||30),a=new AbortController,l=setTimeout(()=>a.abort(),i);o._logger.log({message:"[Request] HttpClient",content:{request:t,attempt:r,maxAttempts:n}});const c=await fetch(t.url,{headers:e({},t.headers,{"x-attempt":r.toString(),"x-max-attempts":n.toString(),accept:"application/json","content-type":"application/json"}),keepalive:!0,body:JSON.stringify(t.body),method:t.method,signal:a.signal});o._logger.log({message:"[Response] HttpClient",content:{response:c,attempt:r,maxAttempts:n}}),clearTimeout(l);const h=await c.json();return{isSuccess:c.ok,isTransientError:o.isTransientError(c),data:c.ok?h.data:h}},`[${t.method}] ${t.url}`)}isTransientError(e){return[409,424,500,503,504].includes(e.status)}}var l,c={__proto__:null,FetchHttpClient:a,Abstractions:{__proto__:null}};class h{log(e){console.log(JSON.stringify(e))}}!function(e){e[e.Trace=0]="Trace",e[e.Debug=1]="Debug",e[e.Information=2]="Information",e[e.Warning=3]="Warning",e[e.Error=4]="Error",e[e.Critical=5]="Critical",e[e.None=6]="None"}(l||(l={}));var g={__proto__:null,get LogLevel(){return l}};class _{constructor(e,t=new h,o=new a(e,t,new i({maxAttempts:3,attemptDelay:5e3},t))){this._httpClient=void 0,this._logger=void 0,this._options=void 0,this._logs=[],this._logger=t,this._options=e,this._httpClient=o,setInterval(this.sendBatch.bind(this),1e3)}log(e){this._logger.log(e),this._options.elasticLoggerUrl&&this._logs.push({customMessage:e.message,message:`[FRONTEND] ${e.message}`,service:{name:"ThreeDSecure.Service.JS",version:"3.0.0"},executionDate:new Date,entrypoint:"Execute",method:e.method,correlationId:e.correlationId,content:e.content,level:e.level})}async sendBatch(){const e=this._logs.splice(0,10);if(e.length)try{await this._httpClient.send({url:this._options.elasticLoggerUrl,method:"POST",body:e})}catch(t){this._logger.log({error:t,message:"Error sending message to elastic",method:"sendBatch",correlationId:e.map(e=>e.correlationId)[0],level:l.Error})}}}var p,u={__proto__:null,ConsoleLogger:h,ElasticLogger:_,Abstractions:g};!function(e){e.width250xheight400="01",e.width390xheight400="02",e.width500xheight600="03",e.width600xheight400="04",e.fullscreen="05"}(p||(p={}));var m={__proto__:null,get ChallengeWindowSize(){return p}};class d{constructor(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}execute(e){return e.challengeUrl?new Promise((o,s)=>{try{this._logger.log({message:"[Request] Challenge execution",content:{authResponse:e}}),r.createIFrame({parent:this._options.container,name:d.IFRAME_NAME,isVisible:!0,useDefaultStyle:!!this._options.onIFrameCreatedFn});const s=r.createForm({parent:this._options.container,name:d.FORM_NAME,actionUrl:e.challengeUrl,target:d.IFRAME_NAME,method:"post"}),n=r.createInput({parent:s,name:d.CREQ_INPUT_NAME,type:d.CREQ_INPUT_TYPE}),i={threeDSServerTransID:e.processId,acsTransID:e.challengeId,messageVersion:e.challengeVersion,messageType:"CReq",challengeWindowSize:this._options.challengeWindowSize||p.width250xheight400},a=t.convert(i);n.value=a,s.submit(),this._logger.log({message:"[Response] Challenge execution",content:{authResponse:e,cReq:i,base64CReq:a}}),o()}catch(t){return this._logger.log({message:"[Error] Challenge execution",content:{authResponse:e,error:t}}),s({message:t.toString()})}}):Promise.resolve()}}d.IFRAME_NAME="challengeIframe",d.FORM_NAME="challengeForm",d.CREQ_INPUT_NAME="creq",d.CREQ_INPUT_TYPE="hidden";class v{constructor(e,t){this._logger=void 0,this._options=void 0,this._logger=t,this._options=e}execute(e){return e.dsMethodUrl?new Promise((o,s)=>{try{var n;this._logger.log({message:"[Request] DirectoryServer execution",content:{preAuthResponse:e}});const s=r.createIFrame({parent:this._options.container,isVisible:!1,name:v.IFRAME_NAME,useDefaultStyle:!!this._options.onIFrameCreatedFn});null==(n=this._options.onIFrameCreatedFn)||n.call(this._options,s);const i=r.createForm({parent:this._options.container,name:v.FORM_NAME,actionUrl:e.dsMethodUrl,target:v.IFRAME_NAME,method:"POST"}),a=r.createInput({parent:i,name:v.FORM_INPUT_NAME,type:v.FROM_INPUT_TYPE}),l=t.convert({threeDSServerTransID:e.processId,threeDSMethodNotificationURL:e.notificationUrl});a.value=l,i.submit(),this._logger.log({message:"[Response] DirectoryServer execution",content:{preAuthResponse:e,threeDSMethodDataBase64:l}}),o()}catch(t){return this._logger.log({message:"[Error] DirectoryServer execution",content:{preAuthResponse:e,error:t}}),s({message:t.toString()})}}):Promise.resolve()}}v.IFRAME_NAME="threeDSMethodIframe",v.FORM_NAME="threeDSMethodForm",v.FORM_INPUT_NAME="threeDSMethodData",v.FROM_INPUT_TYPE="hidden";class A{constructor(e,t=new _(e),o=new a(e,t),s=new v(e,t),r=new d(e,t)){this._options=void 0,this._logger=void 0,this._client=void 0,this._directoryServer=void 0,this._challenge=void 0,this._options=e,this._logger=t,this._client=o,this._directoryServer=s,this._challenge=r,this._logger.log({message:"3DS configured",content:e})}async execute(e){this._logger.log({message:"[Request] PreAuth",content:e});let t=await this._preAuth(e);this._logger.log({message:"[Response] PreAuth",content:t}),await this._directoryServer.execute(t),this._logger.log({message:"[Request] Auth",content:t});let o=await this._auth(t);this._logger.log({message:"[Response] Auth",content:o}),await this._challenge.execute(o),this._logger.log({message:"[Request] PostAuth",content:o});let s=await this._postAuth(o);return this._logger.log({message:"[Response] PostAuth",content:s}),s}_preAuth(e){return this._client.send({url:`${this._options.threeDSecureUrl}/api/v2/${e.id}/preAuth`,method:"POST",body:{browser:o.create()}})}_auth(e){return this._client.send({url:`${this._options.threeDSecureUrl}/api/v1/${e.id}/auth`,method:"POST"})}_postAuth(e){return this._client.send({url:`${this._options.threeDSecureUrl}/api/v2/${e.id}/postAuth`,method:"POST"})}}var y={__proto__:null,IFrameDirectoryServerService:v,IFrameChallengeService:d,ThreeDSecureService:A,Abstractions:m},S={__proto__:null,Abstractions:{__proto__:null},Utils:n};export{c as HttpClients,u as Loggers,y as Services,S as Shared,A as default};
//# sourceMappingURL=index.modern.mjs.map
