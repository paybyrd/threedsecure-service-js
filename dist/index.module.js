function e(){return e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},e.apply(this,arguments)}var t;!function(e){e[e.Trace=0]="Trace",e[e.Debug=1]="Debug",e[e.Information=2]="Information",e[e.Warning=3]="Warning",e[e.Error=4]="Error",e[e.Critical=5]="Critical",e[e.None=6]="None"}(t||(t={}));var r={__proto__:null,get LogLevel(){return t}},n=/*#__PURE__*/function(){function e(){}return e.convert=function(e){var t=JSON.stringify(e);return btoa(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},e}(),o=/*#__PURE__*/function(){function e(){}return e.create=function(){var e=[48,32,24,16,15,8,4,1].find(function(e){return e<=screen.colorDepth});return{javaEnabled:navigator.javaEnabled(),javascriptEnabled:!0,language:navigator.language,userAgent:navigator.userAgent,screenWidth:window.screen.width,screenHeight:window.screen.height,timezoneOffset:(new Date).getTimezoneOffset(),colorDepth:e,acceptHeader:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"}},e}(),i=/*#__PURE__*/function(){function e(e){var t=this;this._task=void 0,this._timeout=void 0,this._task=new Promise(function(r){t._timeout=setTimeout(r,e)})}var t=e.prototype;return t.wait=function(){return this._task},t.cancel=function(){clearTimeout(this._timeout),this._task=Promise.reject({message:"Timer cancelled"})},e.sleep=function(t){return new e(t)},e.cancel=function(e){clearTimeout(e)},e}(),a=/*#__PURE__*/function(){function e(){}return e.createIFrame=function(e){var t,r=document.createElement("iframe");return r.id=e.name,r.name=e.name,e.useDefaultStyle?r.setAttribute("style","border: none;position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%;opacity: "+(e.isVisible?"1":"0")):r.style.opacity=e.isVisible?"1":"0",null==(t=e.parent)||t.appendChild(r),r},e.createForm=function(e){var t=document.createElement("form");return t.id=e.name,t.name=e.name,t.action=e.actionUrl,t.target=e.target,t.method=e.method,e.parent.appendChild(t),t},e.createInput=function(e){var t=document.createElement("input");return t.id=e.name,t.name=e.name,t.type=e.type,e.parent.appendChild(t),t},e}(),s={__proto__:null,Base64Converter:n,Browser:o,Delay:i,HtmlElementFactory:a,Abstractions:{__proto__:null}};function l(e,t,r){if(!e.s){if(r instanceof c){if(!r.s)return void(r.o=l.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(l.bind(null,e,t),l.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var c=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var n=new e,o=this.s;if(o){var i=1&o?t:r;if(i){try{l(n,1,i(this.v))}catch(e){l(n,2,e)}return n}return this}return this.o=function(e){try{var o=e.v;1&e.s?l(n,1,t?t(o):o):r?l(n,1,r(o)):l(n,2,o)}catch(e){l(n,2,e)}},n},e}();function u(e){return e instanceof c&&1&e.s}var h,d=/*#__PURE__*/function(){function e(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}return e.prototype.execute=function(e){var r=this,n=e.executeFn,o=e.method,a=e.correlationId;return new Promise(function(e,s){try{var h,d=function(e){var n;if(h)return e;s(m),r._logger.log({message:'Unhandled error calling "'+o+'"',error:null==(n=m)?void 0:n.error,content:{attempt:p,maxAttempts:r._options.maxAttempts},method:o,correlationId:a,level:t.Error})},p=1,m=null,g=function(e,t){var r;do{var n=e();if(n&&n.then){if(!u(n)){r=!0;break}n=n.v}var o=t();if(u(o)&&(o=o.v),!o)return n}while(!o.then);var i=new c,a=l.bind(null,i,2);return(r?n.then(s):o.then(h)).then(void 0,a),i;function s(r){for(n=r;u(o=t())&&(o=o.v),o;){if(o.then)return void o.then(h).then(void 0,a);if((n=e())&&n.then){if(!u(n))return void n.then(s).then(void 0,a);n=n.v}}l(i,1,n)}function h(r){if(r){do{if((n=e())&&n.then){if(!u(n))return void n.then(s).then(void 0,a);n=n.v}if(u(r=t())&&(r=r.v),!r)return void l(i,1,n)}while(!r.then);r.then(h).then(void 0,a)}else l(i,1,n)}}(function(){function l(e){return h?e:(p++,Promise.resolve(i.sleep(r._options.attemptDelay).wait()).then(function(){}))}var c=function(t,o){try{var i=Promise.resolve(n({attempt:p,maxAttempts:r._options.maxAttempts})).then(function(t){if(t.isSuccess)return e(t.data),void(h=1);t.isTransientError||(s(t),h=1)})}catch(e){return o(e)}return i&&i.then?i.then(void 0,o):i}(0,function(e){m={message:'Unhandled error calling "'+o+'"',error:e,additionalData:{attempt:p,maxAttempts:r._options.maxAttempts}},r._logger.log({message:'Unhandled error calling "'+o+'"',error:e,content:{attempt:p,maxAttempts:r._options.maxAttempts},method:o,correlationId:a,level:t.Warning})});return c&&c.then?c.then(l):l(c)},function(){return!h&&p<=r._options.maxAttempts});return Promise.resolve(g&&g.then?g.then(d):d(g))}catch(e){return Promise.reject(e)}})},e}(),p=/*#__PURE__*/function(){function r(e,t,r){void 0===r&&(r=new d(e,t)),this._options=void 0,this._retryPolicy=void 0,this._logger=void 0,this._retryPolicy=r,this._logger=t,this._options=e}var n=r.prototype;return n.send=function(r){try{var n=this,o=n;return Promise.resolve(n._retryPolicy.execute({executeFn:function(i){var a=i.attempt,s=i.maxAttempts;try{var l=1e3*(o._options.timeoutInSeconds||30),c=new AbortController,u=setTimeout(function(){return c.abort()},l);return n._logger.log({message:"[Request] HttpClient",content:{request:r,attempt:a,maxAttempts:s},method:"send",correlationId:r.correlationId,level:t.Information}),Promise.resolve(fetch(r.url,{headers:e({},r.headers,{"x-attempt":a.toString(),"x-max-attempts":s.toString(),accept:"application/json","content-type":"application/json"}),keepalive:!0,body:JSON.stringify(r.body),method:r.method,signal:c.signal})).then(function(e){return n._logger.log({message:"[Response] HttpClient",content:{response:e,attempt:a,maxAttempts:s},method:"send",correlationId:r.correlationId,level:t.Information}),clearTimeout(u),Promise.resolve(e.json()).then(function(t){return{isSuccess:e.ok,isTransientError:n.isTransientError(e),data:e.ok?t.data:t}})})}catch(e){return Promise.reject(e)}},method:"["+r.method+"] "+r.url,correlationId:r.correlationId}))}catch(e){return Promise.reject(e)}},n.isTransientError=function(e){return[409,424,500,503,504].includes(e.status)},r}(),m={__proto__:null,FetchHttpClient:p,Abstractions:{__proto__:null}},g=/*#__PURE__*/function(){function e(){}return e.prototype.log=function(e){console.log(JSON.stringify(e))},e}(),v=/*#__PURE__*/function(){function e(e,t,r){void 0===t&&(t=new g),void 0===r&&(r=new p(e,t,new d({maxAttempts:3,attemptDelay:5e3},t))),this._httpClient=void 0,this._logger=void 0,this._options=void 0,this._logs=[],this._logger=t,this._options=e,this._httpClient=r,setInterval(this.sendBatch.bind(this),1e3)}var r=e.prototype;return r.log=function(e){this._logger.log(e),this._options.elasticLoggerUrl&&this._logs.push({customMessage:e.message,message:"[FRONTEND] "+e.message,service:{name:"ThreeDSecure.Service.JS",version:"3.0.0"},executionDate:new Date,entrypoint:"Execute",method:e.method,correlationId:e.correlationId,content:e.content,level:e.level})},r.sendBatch=function(){try{var e=this,r=e._logs.splice(0,10);if(!r.length)return Promise.resolve();var n=r.map(function(e){return e.correlationId})[0],o=function(t,o){try{var i=Promise.resolve(e._httpClient.send({url:e._options.elasticLoggerUrl,method:"POST",body:r,correlationId:n})).then(function(){})}catch(e){return o(e)}return i&&i.then?i.then(void 0,o):i}(0,function(r){e._logger.log({error:r,message:"Error sending message to elastic",method:"sendBatch",correlationId:n,level:t.Error})});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},e}(),_={__proto__:null,ConsoleLogger:g,ElasticLogger:v,Abstractions:r};!function(e){e.width250xheight400="01",e.width390xheight400="02",e.width500xheight600="03",e.width600xheight400="04",e.fullscreen="05"}(h||(h={}));var f={__proto__:null,get ChallengeWindowSize(){return h}},I=/*#__PURE__*/function(){function e(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}return e.prototype.execute=function(r){var o=this;return r.authResponse.challengeUrl?new Promise(function(i,s){try{o._logger.log({message:"[Request] Challenge execution",content:{authResponse:r.authResponse},method:"executeChallenge",correlationId:r.correlationId,level:t.Information}),a.createIFrame({parent:o._options.container,name:e.IFRAME_NAME,isVisible:!0,useDefaultStyle:!!o._options.onIFrameCreatedFn});var l=a.createForm({parent:o._options.container,name:e.FORM_NAME,actionUrl:r.authResponse.challengeUrl,target:e.IFRAME_NAME,method:"post"}),c=a.createInput({parent:l,name:e.CREQ_INPUT_NAME,type:e.CREQ_INPUT_TYPE}),u={threeDSServerTransID:r.authResponse.processId,acsTransID:r.authResponse.challengeId,messageVersion:r.authResponse.challengeVersion,messageType:"CReq",challengeWindowSize:o._options.challengeWindowSize||h.width250xheight400},d=n.convert(u);c.value=d,l.submit(),o._logger.log({message:"[Response] Challenge execution",content:{authResponse:r.authResponse,cReq:u,base64CReq:d},method:"executeChallenge",correlationId:r.correlationId,level:t.Information}),i()}catch(e){return o._logger.log({message:"[Error] Challenge execution",content:{authResponse:r.authResponse,error:e},method:"executeChallenge",correlationId:r.correlationId,level:t.Error}),s({message:e.toString()})}}):Promise.resolve()},e}();I.IFRAME_NAME="challengeIframe",I.FORM_NAME="challengeForm",I.CREQ_INPUT_NAME="creq",I.CREQ_INPUT_TYPE="hidden";var y=/*#__PURE__*/function(){function e(e,t){this._logger=void 0,this._options=void 0,this._logger=t,this._options=e}return e.prototype.execute=function(r){var o=this;return r.preAuthResponse.dsMethodUrl?new Promise(function(i,s){try{var l;o._logger.log({message:"[Request] DirectoryServer execution",content:r,method:"directoryServerExecute",correlationId:r.correlationId,level:t.Information});var c=a.createIFrame({parent:o._options.container,isVisible:!1,name:e.IFRAME_NAME,useDefaultStyle:!!o._options.onIFrameCreatedFn});null==(l=o._options.onIFrameCreatedFn)||l.call(o._options,c);var u=a.createForm({parent:o._options.container,name:e.FORM_NAME,actionUrl:r.preAuthResponse.dsMethodUrl,target:e.IFRAME_NAME,method:"POST"}),h=a.createInput({parent:u,name:e.FORM_INPUT_NAME,type:e.FROM_INPUT_TYPE}),d=n.convert({threeDSServerTransID:r.preAuthResponse.processId,threeDSMethodNotificationURL:r.preAuthResponse.notificationUrl});h.value=d,u.submit(),o._logger.log({message:"[Response] DirectoryServer execution",content:{request:r,threeDSMethodDataBase64:d},method:"directoryServerExecute",correlationId:r.correlationId,level:t.Information}),i()}catch(e){return o._logger.log({message:"[Error] DirectoryServer execution",content:{request:r,error:e},method:"directoryServerExecute",correlationId:r.correlationId,level:t.Error}),s({message:e.toString()})}}):Promise.resolve()},e}();y.IFRAME_NAME="threeDSMethodIframe",y.FORM_NAME="threeDSMethodForm",y.FORM_INPUT_NAME="threeDSMethodData",y.FROM_INPUT_TYPE="hidden";var A=/*#__PURE__*/function(){function e(e,t,r,n,o){void 0===t&&(t=new v(e)),void 0===r&&(r=new p(e,t)),void 0===n&&(n=new y(e,t)),void 0===o&&(o=new I(e,t)),this._options=void 0,this._logger=void 0,this._client=void 0,this._directoryServer=void 0,this._challenge=void 0,this._options=e,this._logger=t,this._client=r,this._directoryServer=n,this._challenge=o}var r=e.prototype;return r.execute=function(e){try{var t=this;return Promise.resolve(t._preAuth(e)).then(function(r){return Promise.resolve(t._directoryServer.execute({preAuthResponse:r,correlationId:e.correlationId})).then(function(){return Promise.resolve(t._auth(e)).then(function(r){return Promise.resolve(t._challenge.execute({authResponse:r,correlationId:e.correlationId})).then(function(){return Promise.resolve(t._postAuth(e))})})})})}catch(e){return Promise.reject(e)}},r._preAuth=function(e){return this._logger.log({message:"Executing PreAuth",content:e,method:"_preAuth",correlationId:e.correlationId,level:t.Information}),this._client.send({url:this._options.threeDSecureUrl+"/api/v2/"+e.id+"/preAuth",method:"POST",body:{browser:o.create()},correlationId:e.correlationId})},r._auth=function(e){return this._logger.log({message:"Executing Auth",content:e,method:"_auth",correlationId:e.correlationId,level:t.Information}),this._client.send({url:this._options.threeDSecureUrl+"/api/v1/"+e.id+"/auth",method:"POST",correlationId:e.correlationId})},r._postAuth=function(e){return this._logger.log({message:"Executing PostAuth",content:e,method:"_postAuth",correlationId:e.correlationId,level:t.Information}),this._client.send({url:this._options.threeDSecureUrl+"/api/v2/"+e.id+"/postAuth",method:"POST",correlationId:e.correlationId})},e}(),E={__proto__:null,IFrameDirectoryServerService:y,IFrameChallengeService:I,ThreeDSecureService:A,Abstractions:f},x={__proto__:null,Abstractions:{__proto__:null},Utils:s};export{m as HttpClients,_ as Loggers,E as Services,x as Shared,A as default};
//# sourceMappingURL=index.module.js.map
