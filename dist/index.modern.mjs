function e(){return e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},e.apply(this,arguments)}var t;!function(e){e[e.Trace=0]="Trace",e[e.Debug=1]="Debug",e[e.Information=2]="Information",e[e.Warning=3]="Warning",e[e.Error=4]="Error",e[e.Critical=5]="Critical",e[e.None=6]="None"}(t||(t={}));var r={__proto__:null,get LogLevel(){return t}};class o{constructor(){this.start=void 0,this.end=void 0,this.start=Date.now()}stop(){this.end=Date.now()}get elapsed(){return(this.end||Date.now())-this.start}}class n{static convert(e){const t=JSON.stringify(e);return btoa(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}}class a{static create(){const e=[48,32,24,16,15,8,4,1].find(e=>e<=screen.colorDepth);return{javaEnabled:navigator.javaEnabled(),javascriptEnabled:!0,language:navigator.language,userAgent:navigator.userAgent,screenWidth:window.screen.width,screenHeight:window.screen.height,timezoneOffset:(new Date).getTimezoneOffset(),colorDepth:e,acceptHeader:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"}}}class i{constructor(e){this._task=void 0,this._timeout=void 0,this._task=new Promise(t=>{this._timeout=setTimeout(t,e)})}wait(){return this._task}cancel(){clearTimeout(this._timeout),this._task=Promise.reject({message:"Timer cancelled"})}static sleep(e){return new i(e)}static cancel(e){clearTimeout(e)}}class s{static createIFrame(e){const t=document.createElement("iframe");return t.id=e.name,t.name=e.name,e.onReadyFn&&e.onReadyFn(t,e.isVisible),e.onCreatedFn&&(e.onCreatedFn(t),t.style.opacity=e.isVisible?"1":"0"),e.parent.appendChild(t),t}static createForm(e){const t=document.createElement("form");return t.id=e.name,t.name=e.name,t.action=e.actionUrl,t.target=e.target,t.method=e.method,e.parent.appendChild(t),t}static createInput(e){const t=document.createElement("input");return t.id=e.name,t.name=e.name,t.type=e.type,e.parent.appendChild(t),t}}var l={__proto__:null,Base64Converter:n,Browser:a,Delay:i,HtmlElementFactory:s,Abstractions:{__proto__:null}};class c{constructor(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}execute({executeFn:e,method:r,correlationId:o}){var n=this;return new Promise(async function(a,s){var l;let c=1,h=null;do{try{let t=await e({attempt:c,maxAttempts:n._options.maxAttempts});if(t.isSuccess)return void a(t);if(!t.isTransientError)return void s(t)}catch(e){h={message:`Unhandled error calling "${r}"`,error:e,additionalData:{attempt:c,maxAttempts:n._options.maxAttempts}},n._logger.log({message:`Unhandled error calling "${r}"`,error:e,content:{attempt:c,maxAttempts:n._options.maxAttempts},method:r,correlationId:o,level:t.Warning})}c++,await i.sleep(n._options.attemptDelay).wait()}while(c<=n._options.maxAttempts);s(h),n._logger.log({message:`Unhandled error calling "${r}"`,error:null==(l=h)?void 0:l.error,content:{attempt:c,maxAttempts:n._options.maxAttempts},method:r,correlationId:o,level:t.Error})})}}class h{constructor(e,t,r=new c(e,t)){this._options=void 0,this._retryPolicy=void 0,this._logger=void 0,this._retryPolicy=r,this._logger=t,this._options=e}async send(r){var n=this;const a=this;return await this._retryPolicy.execute({executeFn:async function({attempt:i,maxAttempts:s}){const l=1e3*(a._options.timeoutInSeconds||30),c=new AbortController,h=setTimeout(()=>c.abort(),l),d=new URL(r.url);n._logger.log({message:`ExternalService - Request (${d.host})`,content:{request:r,attempt:i,maxAttempts:s},method:"send",correlationId:r.correlationId,level:t.Information});const g=new o;let m;try{m=await fetch(r.url,{headers:e({},r.headers,{"x-attempt":i.toString(),"x-max-attempts":s.toString(),accept:"application/json","content-type":"application/json",correlationId:r.correlationId}),keepalive:!0,body:JSON.stringify(r.body),method:r.method,signal:c.signal}),n._logger.log({message:`ExternalService - Response (${d.host}) in ${g.elapsed}ms`,content:{request:r,attempt:i,maxAttempts:s,response:m},method:"send",correlationId:r.correlationId,level:t.Error})}catch(e){throw n._logger.log({message:`ExternalService - Error (${d.host}) in ${g.elapsed}ms`,content:{request:r,attempt:i,maxAttempts:s,error:e},method:"send",correlationId:r.correlationId,level:t.Error}),e}return clearTimeout(h),{isSuccess:m.ok,isTransientError:n.isTransientError(m),getData:async function(){return(await m.json()).data}}},method:`[${r.method}] ${r.url}`,correlationId:r.correlationId})}isTransientError(e){return[409,424,500,503,504].includes(e.status)}}var d={__proto__:null,FetchHttpClient:h,Abstractions:{__proto__:null}};class g{flush(){return Promise.resolve()}log(t){var r;const o=e({},t,{error:null==(r=t.error)?void 0:r.toString()});console.log(o)}}class m{constructor(e,t=new g,r=new h(e,t,new c({maxAttempts:3,attemptDelay:5e3},t))){this._httpClient=void 0,this._logger=void 0,this._options=void 0,this._logs=[],this._interval=void 0,this._logger=t,this._options=e,this._httpClient=r,this._interval=setInterval(this.sendBatch.bind(this),1e3*(this._options.batchLogIntervalInSeconds||m.DEFAULT_BATCH_TIMEOUT))}log(t){var r;this._logger.log(t),this._options.restLoggerUrl&&this._logs.unshift({customMessage:t.message,message:`[Paybyrd.ThreeDSecure.JS] ${t.message}`,service:{name:"Paybyrd.ThreeDSecure.JS",version:"3.0.0"},environment:this._options.environment||"Development",executionDate:new Date,entrypoint:"Execute",method:t.method,correlationId:t.correlationId,content:e({},t.content,{error:null==(r=t.error)?void 0:r.toString()}),level:t.level})}async flush(){for(clearInterval(this._interval);this._logs.length;)await this.sendBatch();this._interval=setInterval(this.sendBatch.bind(this),1e3*(this._options.batchLogIntervalInSeconds||m.DEFAULT_BATCH_TIMEOUT))}async sendBatch(){const e=this._logs.splice(0,10);if(!e.length)return;const r=e.map(e=>e.correlationId)[0];try{await this._httpClient.send({url:this._options.restLoggerUrl,method:"POST",body:e,correlationId:r})}catch(e){this._logger.log({error:e,message:"Error sending message to elastic",method:"sendBatch",correlationId:r,level:t.Error})}}}m.DEFAULT_BATCH_TIMEOUT=5;var u,p={__proto__:null,ConsoleLogger:g,RestLogger:m,Abstractions:r};!function(e){e.width250xheight400="01",e.width390xheight400="02",e.width500xheight600="03",e.width600xheight400="04",e.fullscreen="05"}(u||(u={}));var _={__proto__:null,get ChallengeWindowSize(){return u}};class v{constructor(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}execute(e){return e.authResponse.challengeUrl?new Promise((r,a)=>{try{this._logger.log({message:"Challenge - Start",content:{authResponse:e.authResponse},method:"executeChallenge",correlationId:e.correlationId,level:t.Information}),this._options.container.innerHTML="";const a=s.createIFrame({parent:this._options.container,name:v.IFRAME_NAME,isVisible:!0,useDefaultStyle:!!this._options.onIFrameCreatedFn,onCreatedFn:this._options.onIFrameCreatedFn,onReadyFn:this._options.onIFrameReadyFn});this._logger.log({message:"Challenge - Create iFrame",method:"executeChallenge",correlationId:e.correlationId,level:t.Information});const i=s.createForm({parent:this._options.container,name:v.FORM_NAME,actionUrl:e.authResponse.challengeUrl,target:v.IFRAME_NAME,method:"post"});this._logger.log({message:"Challenge - Create form",method:"executeChallenge",correlationId:e.correlationId,level:t.Information});const l=s.createInput({parent:i,name:v.CREQ_INPUT_NAME,type:v.CREQ_INPUT_TYPE});this._logger.log({message:"Challenge - Create input",method:"executeChallenge",correlationId:e.correlationId,level:t.Information});const c={threeDSServerTransID:e.authResponse.processId,acsTransID:e.authResponse.challengeId,messageVersion:e.authResponse.challengeVersion,messageType:"CReq",challengeWindowSize:this._options.challengeWindowSize||u.width250xheight400},h=n.convert(c);l.value=h,this._logger.log({message:"Challenge - Prepare cReq",content:{cReq:c,base64CReq:h},method:"executeChallenge",correlationId:e.correlationId,level:t.Information});const d=new o,g=()=>{var r;const o=a.contentDocument||(null==(r=a.contentWindow)?void 0:r.document);"complete"!=(null==o?void 0:o.readyState)?setTimeout(g,100):this._logger.log({message:`Challenge - iFrame loaded in ${d.elapsed}ms`,content:{iFrame:o.body.innerText},method:"executeChallenge",correlationId:e.correlationId,level:t.Information})};i.submit(),setTimeout(g,100),this._logger.log({message:"Challenge - Submit form",content:{authResponse:e.authResponse,cReq:c,base64CReq:h},method:"executeChallenge",correlationId:e.correlationId,level:t.Information}),r()}catch(r){return this._logger.log({message:"Challenge - error",content:{authResponse:e.authResponse},error:r,method:"executeChallenge",correlationId:e.correlationId,level:t.Error}),a({message:r.toString()})}}):Promise.resolve()}}v.IFRAME_NAME="challengeIframe",v.FORM_NAME="challengeForm",v.CREQ_INPUT_NAME="creq",v.CREQ_INPUT_TYPE="hidden";class I{constructor(e,t){this._logger=void 0,this._options=void 0,this._logger=t,this._options=e}execute(e){return e.preAuthResponse.dsMethodUrl?new Promise((r,a)=>{try{var i;this._logger.log({message:"DirectoryServer - Start",content:{preAuthResponse:e},method:"executeDirectoryServer",correlationId:e.correlationId,level:t.Information}),this._options.container.innerHTML="";const a=s.createIFrame({parent:this._options.container,isVisible:!1,name:I.IFRAME_NAME,useDefaultStyle:!!this._options.onIFrameCreatedFn});null==(i=this._options.onIFrameCreatedFn)||i.call(this._options,a),this._logger.log({message:"DirectoryServer - Create iFrame",method:"executeDirectoryServer",correlationId:e.correlationId,level:t.Information});const l=s.createForm({parent:this._options.container,name:I.FORM_NAME,actionUrl:e.preAuthResponse.dsMethodUrl,target:I.IFRAME_NAME,method:"POST"});this._logger.log({message:"DirectoryServer - Create Form",method:"executeDirectoryServer",correlationId:e.correlationId,level:t.Information});const c=s.createInput({parent:l,name:I.FORM_INPUT_NAME,type:I.FROM_INPUT_TYPE});this._logger.log({message:"DirectoryServer - Create Input",method:"executeDirectoryServer",correlationId:e.correlationId,level:t.Information});const h={threeDSServerTransID:e.preAuthResponse.processId,threeDSMethodNotificationURL:e.preAuthResponse.notificationUrl},d=n.convert(h);c.value=d,this._logger.log({message:"DirectoryServer - Prepare threeDSMethodData",content:{threeDSMethodData:h,threeDSMethodDataBase64:d},method:"executeDirectoryServer",correlationId:e.correlationId,level:t.Information});const g=new o,m=()=>{var r;const o=a.contentDocument||(null==(r=a.contentWindow)?void 0:r.document);"complete"!=(null==o?void 0:o.readyState)?setTimeout(m,100):this._logger.log({message:`DirectoryServer - iFrame loaded in ${g.elapsed}ms`,content:{iFrame:o.body.innerText},method:"executeDirectoryServer",correlationId:e.correlationId,level:t.Information})};l.submit(),setTimeout(m,100),this._logger.log({message:"DirectoryServer - Submit form",content:{threeDSMethodData:h,threeDSMethodDataBase64:d},method:"executeDirectoryServer",correlationId:e.correlationId,level:t.Information}),r()}catch(r){return this._logger.log({message:"DirectoryServer - Error",content:{preAuthResponse:e},error:r,method:"directoryServerExecute",correlationId:e.correlationId,level:t.Error}),a({message:r.toString()})}}):Promise.resolve()}}I.IFRAME_NAME="threeDSMethodIframe",I.FORM_NAME="threeDSMethodForm",I.FORM_INPUT_NAME="threeDSMethodData",I.FROM_INPUT_TYPE="hidden";class S{constructor(e,t=new m(e),r=new h(e,t),o=new I(e,t),n=new v(e,t)){this._options=void 0,this._logger=void 0,this._client=void 0,this._directoryServer=void 0,this._challenge=void 0,this._options=e,this._logger=t,this._client=r,this._directoryServer=o,this._challenge=n}async execute(e){let t=await this.preAuth(e);await this._directoryServer.execute({preAuthResponse:t,correlationId:e.correlationId});let r=await this.auth(e);await this._challenge.execute({authResponse:r,correlationId:e.correlationId});let o=await this.postAuth(e);return await this._logger.flush(),o}async preAuth(e){this._logger.log({message:"Executing PreAuth",content:e,method:"_preAuth",correlationId:e.correlationId,level:t.Information});const r=await this._client.send({url:`${this._options.threeDSecureUrl}/api/v2/${e.id}/preAuth`,method:"POST",body:{browser:a.create()},correlationId:e.correlationId});return await r.getData()}async auth(e){this._logger.log({message:"Executing Auth",content:e,method:"_auth",correlationId:e.correlationId,level:t.Information});const r=await this._client.send({url:`${this._options.threeDSecureUrl}/api/v1/${e.id}/auth`,method:"POST",correlationId:e.correlationId});return await r.getData()}async postAuth(e){this._logger.log({message:"Executing PostAuth",content:e,method:"_postAuth",correlationId:e.correlationId,level:t.Information});const r=await this._client.send({url:`${this._options.threeDSecureUrl}/api/v2/${e.id}/postAuth`,method:"POST",correlationId:e.correlationId});return await r.getData()}}var y={__proto__:null,IFrameDirectoryServerService:I,IFrameChallengeService:v,ThreeDSecureService:S,Abstractions:_},D={__proto__:null,Abstractions:{__proto__:null},Utils:l};export{d as HttpClients,p as Loggers,y as Services,D as Shared,S as ThreeDSecureService};
//# sourceMappingURL=index.modern.mjs.map
