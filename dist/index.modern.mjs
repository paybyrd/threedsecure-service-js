function e(){return e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},e.apply(this,arguments)}class t{static convert(e){const t=JSON.stringify(e);return Buffer.from(t,"utf-8").toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}}class r{static create(){const e=[48,32,24,16,15,8,4,1].find(e=>e<=screen.colorDepth);return{javaEnabled:navigator.javaEnabled(),javascriptEnabled:!0,language:navigator.language,userAgent:navigator.userAgent,screenWidth:window.screen.width,screenHeight:window.screen.height,timezoneOffset:(new Date).getTimezoneOffset(),colorDepth:e,acceptHeader:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"}}}class o{constructor(e){this._task=void 0,this._timeout=void 0,this._task=new Promise(t=>{this._timeout=setTimeout(t,e)})}wait(){return this._task}cancel(){clearTimeout(this._timeout),this._task=Promise.reject({message:"Timer cancelled"})}static sleep(e){return new o(e)}static cancel(e){clearTimeout(e)}}class s{static createIFrame(e){var t;const r=document.createElement("iframe");return r.id=e.name,r.name=e.name,e.useDefaultStyle?r.setAttribute("style","border: none;position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%;opacity: "+(e.isVisible?"1":"0")):r.style.opacity=e.isVisible?"1":"0",null==(t=e.parent)||t.appendChild(r),r}static createForm(e){const t=document.createElement("form");return t.id=e.name,t.name=e.name,t.action=e.actionUrl,t.target=e.target,t.method=e.method,e.parent.appendChild(t),t}static createInput(e){const t=document.createElement("input");return t.id=e.name,t.name=e.name,t.type=e.type,e.parent.appendChild(t),t}}var n={__proto__:null,Base64Converter:t,Browser:r,Delay:o,HtmlElementFactory:s,Abstractions:{__proto__:null}};class i{constructor(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}execute(e,t){var r=this;return new Promise(async function(s,n){let i=1,a=null;do{try{let t=await e({attempt:i,maxAttempts:r._options.maxAttempts});if(t.isSuccess)return void s(t.data);if(!t.isTransientError)return void n(t)}catch(e){a={message:`Unhandled error calling "${t}"`,error:e,additionalData:{attempt:i,maxAttempts:r._options.maxAttempts}},r._logger.log(a)}i++,await o.sleep(r._options.attemptDelay).wait()}while(i<=r._options.maxAttempts);n(a)})}}class a{constructor(e,t,r=new i(e,t)){this._options=void 0,this._retryPolicy=void 0,this._logger=void 0,this._retryPolicy=r,this._logger=t}async send(t){var r=this;return await this._retryPolicy.execute(async function({attempt:o,maxAttempts:s}){const n=new AbortController,i=setTimeout(()=>n.abort(),1e3*r._options.timeoutInSeconds);r._logger.log({message:"[Request] HttpClient",content:{request:t,attempt:o,maxAttempts:s}});const a=await fetch(t.url,{headers:e({},t.headers,{"x-attempt":o.toString(),"x-max-attempts":s.toString(),accept:"application/json","content-type":"application/json"}),keepalive:!0,body:JSON.stringify(t.body),method:t.method,signal:n.signal});return r._logger.log({message:"[Response] HttpClient",content:{response:a,attempt:o,maxAttempts:s}}),clearTimeout(i),{isSuccess:a.ok,isTransientError:r.isTransientError(a),data:await a.json()}},`[${t.method}] ${t.url}`)}isTransientError(e){return[409,424,500,503,504].includes(e.status)}}var l={__proto__:null,FetchHttpClient:a,Abstractions:{__proto__:null}};class c{log(e){console.log(JSON.stringify(e))}}var h,g={__proto__:null,ConsoleLogger:c,Abstractions:{__proto__:null}};!function(e){e.width250xheight400="01",e.width390xheight400="02",e.width500xheight600="03",e.width600xheight400="04",e.fullscreen="05"}(h||(h={}));var _={__proto__:null,get ChallengeWindowSize(){return h}};class p{constructor(e,t){this._options=void 0,this._logger=void 0,this._options=e,this._logger=t}execute(e){return new Promise((r,o)=>{try{this._logger.log({message:"[Request] Challenge execution",content:{authResponse:e}}),s.createIFrame({parent:this._options.container,name:p.IFRAME_NAME,isVisible:!0,useDefaultStyle:!!this._options.onIFrameCreatedFn});const o=s.createForm({parent:this._options.container,name:p.FORM_NAME,actionUrl:e.challengeUrl,target:p.IFRAME_NAME,method:"post"}),n=s.createInput({parent:o,name:p.CREQ_INPUT_NAME,type:p.CREQ_INPUT_TYPE}),i={threeDSServerTransID:e.processId,acsTransID:e.challengeId,messageVersion:e.challengeVersion,messageType:"CReq",challengeWindowSize:this._options.challengeWindowSize||h.width250xheight400},a=t.convert(i);n.value=a,o.submit(),this._logger.log({message:"[Response] Challenge execution",content:{authResponse:e,cReq:i,base64CReq:a}}),r()}catch(t){return this._logger.log({message:"[Error] Challenge execution",content:{authResponse:e,error:t}}),o({message:t.toString()})}})}}p.IFRAME_NAME="challengeIframe",p.FORM_NAME="challengeForm",p.CREQ_INPUT_NAME="creq",p.CREQ_INPUT_TYPE="hidden";class u{constructor(e,t){this._logger=void 0,this._options=void 0,this._logger=t,this._options=e}execute(e){return e.dsMethodUrl?new Promise((r,o)=>{try{var n;this._logger.log({message:"[Request] DirectoryServer execution",content:{preAuthResponse:e}});const o=s.createIFrame({parent:this._options.container,isVisible:!1,name:u.IFRAME_NAME,useDefaultStyle:!!this._options.onIFrameCreatedFn});null==(n=this._options.onIFrameCreatedFn)||n.call(this._options,o);const i=s.createForm({parent:this._options.container,name:u.FORM_NAME,actionUrl:e.dsMethodUrl,target:u.IFRAME_NAME,method:"POST"}),a=s.createInput({parent:i,name:u.FORM_INPUT_NAME,type:u.FROM_INPUT_TYPE}),l=t.convert({threeDSServerTransID:e.processId,threeDSMethodNotificationURL:e.notificationUrl});a.value=l,i.submit(),this._logger.log({message:"[Response] DirectoryServer execution",content:{preAuthResponse:e,threeDSMethodDataBase64:l}}),r()}catch(t){return this._logger.log({message:"[Error] DirectoryServer execution",content:{preAuthResponse:e,error:t}}),o({message:t.toString()})}}):Promise.resolve()}}u.IFRAME_NAME="threeDSMethodIframe",u.FORM_NAME="threeDSMethodForm",u.FORM_INPUT_NAME="threeDSMethodData",u.FROM_INPUT_TYPE="hidden";class m{constructor(e,t=new c,r=new a(e,t),o=new u(e,t),s=new p(e,t)){this._options=void 0,this._logger=void 0,this._client=void 0,this._directoryServer=void 0,this._challenge=void 0,this._options=e,this._logger=t,this._client=r,this._directoryServer=o,this._challenge=s}async execute(t){this._logger.log({message:"[Request] PreAuth",content:t});let r=await this._preAuth(t);this._logger.log({message:"[Response] PreAuth",content:r}),await this._directoryServer.execute(r),this._logger.log({message:"[Request] Auth",content:r});let o=await this._auth(r);this._logger.log({message:"[Response] Auth",content:o}),await this._challenge.execute(o),this._logger.log({message:"[Request] PostAuth",content:o});let s=await this._postAuth(o);return this._logger.log({message:"[Response] PostAuth",content:s}),e({},s)}_preAuth(e){return this._client.send({url:`${this._options.threeDSecureUrl}/api/v2/${e.id}/preAuth`,method:"POST",body:{browser:r.create()}})}_auth(e){return this._client.send({url:`${this._options.threeDSecureUrl}/api/v1/${e.id}/auth`,method:"POST"})}_postAuth(e){return this._client.send({url:`${this._options.threeDSecureUrl}/api/v2/${e.id}/postAuth`,method:"POST"})}}var d={__proto__:null,IFrameDirectoryServerService:u,IFrameChallengeService:p,ThreeDSecureService:m,Abstractions:_},v={__proto__:null,Abstractions:{__proto__:null},Utils:n};export{l as HttpClients,g as Loggers,d as Services,v as Shared,m as default};
//# sourceMappingURL=index.modern.mjs.map
